<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©ä»¶æ¤œç´¢ | Premium View</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Outfit:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --border: #e2e8f0;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --radius: 16px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', 'Noto Sans JP', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 2rem;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            flex-shrink: 0;
            z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.02em;
        }

        .filter-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-sub);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .filter-group {
            margin-bottom: 2rem;
        }

        .filter-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-main);
        }

        .filter-value {
            color: var(--primary);
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
        }

        input[type=range] {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--surface);
            border: 2px solid var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:active {
            transform: scale(1.1);
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-sub);
            margin-top: 0.5rem;
            font-family: 'Outfit', sans-serif;
        }

        /* Checkboxes */
        #station-checkboxes {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.75rem;
            background: #f8fafc;
        }

        #station-checkboxes label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 500;
        }

        #station-checkboxes label:hover {
            background: white;
        }

        input[type=checkbox] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            border-radius: 4px;
            cursor: pointer;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            padding: 0.5rem 0;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--border);
            border-radius: 13px;
            transition: 0.3s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .toggle-container input[type=checkbox] {
            display: none;
        }

        .toggle-container input[type=checkbox]:checked+.toggle-switch {
            background: var(--primary);
        }

        .toggle-container input[type=checkbox]:checked+.toggle-switch::after {
            transform: translateX(22px);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem 3rem;
            height: 100vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 2rem;
            padding-top: 3.5rem;
            /* Space for fixed sort button */
            position: relative;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: none;
            /* Hidden on desktop */
        }

        .stats {
            font-size: 1rem;
            color: var(--text-sub);
        }

        .stats strong {
            color: var(--text-main);
            font-weight: 700;
            font-size: 1.25rem;
            font-family: 'Outfit', sans-serif;
        }

        .sort-select {
            position: fixed;
            top: 1rem;
            right: 1.5rem;
            z-index: 40;
            padding: 0.6rem 1.2rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            font-family: inherit;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-main);
            cursor: pointer;
            box-shadow: var(--shadow);
            appearance: none;
            /* Custom Arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            background-size: 1rem;
            padding-right: 2.2rem;
            width: auto;
        }

        .sort-select:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .sort-select {
                top: 12px;
                right: 12px;
                padding: 0.4rem 1.8rem 0.4rem 0.8rem;
                font-size: 0.75rem;
                background-position: right 0.4rem center;
                max-width: 140px;
                /* Prevent it from being too wide */
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
            }

            .header {
                padding-top: 3rem;
            }
        }

        /* Grid */
        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1.5rem;
            padding-bottom: 4rem;
        }

        /* Card */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid transparent;
            height: 100%;
        }

        .card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .card-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            z-index: 10;
            box-shadow: var(--shadow-sm);
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-ended {
            background: #fee2e2;
            color: #991b1b;
        }

        .card-body {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .card-source {
            font-size: 0.7rem;
            color: var(--primary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
            line-height: 1.4;
            color: var(--text-main);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .price-section {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .total-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            font-family: 'Outfit', sans-serif;
        }

        .price-unit {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .price-breakdown {
            font-size: 0.75rem;
            color: var(--text-sub);
            margin-left: auto;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            background: #f8fafc;
            padding: 0.5rem;
            border-radius: 6px;
        }

        .info-label {
            font-size: 0.65rem;
            color: var(--text-sub);
            margin-bottom: 2px;
            font-weight: 600;
        }

        .info-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
        }

        .address {
            font-size: 0.8rem;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: auto;
            padding-top: 0.5rem;
        }

        .card-footer {
            padding: 0.75rem 1rem;
            background: #f8fafc;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .last-updated {
            font-size: 0.75rem;
            color: var(--text-sub);
            font-weight: 500;
        }

        .btn-link {
            background: var(--text-main);
            color: white;
            text-decoration: none;
            padding: 0.6rem 1.25rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .btn-link:hover {
            background: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        /* Mobile Filter Button */
        .mobile-filter-btn {
            display: none;
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            box-shadow: var(--shadow-lg);
            border: none;
            z-index: 100;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: transform 0.2s;
        }

        .mobile-filter-btn:active {
            transform: scale(0.95);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                padding: 1.5rem;
                width: 100%;
            }

            .mobile-filter-btn {
                display: flex;
            }

            .page-title {
                display: block;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .sort-select {
                width: 100%;
            }

            .header>div {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Mobile Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                ğŸ  ä¸å‹•ç”£ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼
            </div>

            <div class="filter-section">
                <h3>çµã‚Šè¾¼ã¿æ¡ä»¶</h3>

                <div class="filter-group">
                    <label>
                        æœ€å¤§ç·è³ƒæ–™
                        <span class="filter-value" id="price-val"></span>
                    </label>
                    <input type="range" id="price-max" min="0" max="30" step="0.5" value="13">
                    <div class="range-labels">
                        <span>0ä¸‡å††</span>
                        <span>30ä¸‡å††+</span>
                    </div>
                </div>

                <div class="filter-group">
                    <label>
                        æœ€å°é¢ç©
                        <span class="filter-value" id="area-val"></span>
                    </label>
                    <input type="range" id="area-min" min="0" max="60" step="1" value="20">
                    <div class="range-labels">
                        <span>0mÂ²</span>
                        <span>60mÂ²+</span>
                    </div>
                </div>

                <div class="filter-group">
                    <label>
                        é§…å¾’æ­©ï¼ˆæœ€å¤§ï¼‰
                        <span class="filter-value" id="walk-val"></span>
                    </label>
                    <input type="range" id="walk-max" min="1" max="20" step="1" value="7">
                    <div class="range-labels">
                        <span>1åˆ†</span>
                        <span>20åˆ†+</span>
                    </div>
                </div>

                <div class="filter-group">
                    <label>é§… (è¤‡æ•°é¸æŠå¯)</label>
                    <div id="station-checkboxes">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="filter-group">
                    <label class="toggle-container">
                        <input type="checkbox" id="show-ended">
                        <div class="toggle-switch"></div>
                        <span style="font-weight:normal;">æ²è¼‰çµ‚äº†ç‰©ä»¶ã‚’è¡¨ç¤º</span>
                    </label>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <div>
                    <div class="page-title">ç‰©ä»¶ä¸€è¦§</div>
                    <div class="stats">
                        <strong id="count">0</strong> ä»¶
                    </div>
                </div>
                <select id="sort-select" class="sort-select" onchange="filterProperties()">
                    <option value="newest">æ–°ç€é †</option>
                    <option value="price_asc">ä¾¡æ ¼: å®‰ã„é †</option>
                    <option value="price_desc">ä¾¡æ ¼: é«˜ã„é †</option>
                    <option value="area_desc">é¢ç©: åºƒã„é †</option>
                    <option value="walk_asc">é§…å¾’æ­©: è¿‘ã„é †</option>
                    <option value="real_walk_asc">å®Ÿå¾’æ­©: è¿‘ã„é †</option>
                </select>
            </div>

            <div id="grid" class="property-grid">
                <!-- Cards injected via JS -->
            </div>
        </main>

        <!-- Mobile Filter Button -->
        <button class="mobile-filter-btn" id="mobile-filter-btn">
            ğŸ”
        </button>
    </div>

    <script>
        // DOM Elements
        const priceSlider = document.getElementById('price-max');
        const areaSlider = document.getElementById('area-min');
        const walkSlider = document.getElementById('walk-max');
        const showEndedCheck = document.getElementById('show-ended');
        const sortSelect = document.getElementById('sort-select');

        const countSpan = document.getElementById('count');
        const priceVal = document.getElementById('price-val');
        const areaVal = document.getElementById('area-val');
        const walkVal = document.getElementById('walk-val');

        // Mobile Menu
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const mobileBtn = document.getElementById('mobile-filter-btn');

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        mobileBtn.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);

        // Data injected by Flask/Jinja2
        const allProperties = {{ properties | tojson }} || [];
        console.log("Loaded properties:", allProperties);

        // Initialize
        try {
            if (Array.isArray(allProperties) && allProperties.length > 0) {
                populateStations(allProperties);
                updateFilterLabels();
                filterProperties();
            } else {
                console.warn("No properties found or invalid data format.");
                renderProperties([]);
            }
        } catch (e) {
            console.error("Initialization error:", e);
            document.getElementById('grid').innerHTML = `<div style="color:red; padding:2rem;">Error: ${e.message}</div>`;
        }

        function updateFilterLabels() {
            priceVal.textContent = `${priceSlider.value}ä¸‡å††`;
            areaVal.textContent = `${areaSlider.value}mÂ²`;
            walkVal.textContent = `${walkSlider.value}åˆ†`;
        }

        function populateStations(data) {
            const stations = new Set();
            data.forEach(p => {
                if (p.nearest_station) stations.add(p.nearest_station);
            });
            const sortedStations = Array.from(stations).sort();

            const container = document.getElementById('station-checkboxes');
            container.innerHTML = '';

            // Select All Checkbox
            const allLabel = document.createElement('label');
            allLabel.style.display = 'flex';
            allLabel.style.alignItems = 'center';
            allLabel.style.gap = '0.5rem';
            allLabel.style.marginBottom = '0.5rem';
            allLabel.style.paddingBottom = '0.5rem';
            allLabel.style.borderBottom = '1px solid var(--border)';
            allLabel.style.fontSize = '0.9rem';
            allLabel.style.fontWeight = 'bold';
            allLabel.style.cursor = 'pointer';

            const allCheckbox = document.createElement('input');
            allCheckbox.type = 'checkbox';
            allCheckbox.id = 'select-all-stations';

            allLabel.appendChild(allCheckbox);
            allLabel.appendChild(document.createTextNode('ã™ã¹ã¦é¸æŠ / è§£é™¤'));
            container.appendChild(allLabel);

            const stationCheckboxes = [];

            sortedStations.forEach(s => {
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '0.5rem';
                label.style.marginBottom = '0.25rem';
                label.style.fontSize = '0.9rem';
                label.style.cursor = 'pointer';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = s;
                checkbox.className = 'station-checkbox';
                checkbox.addEventListener('change', () => {
                    filterProperties();
                    updateSelectAllState();
                });

                stationCheckboxes.push(checkbox);
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(s));
                container.appendChild(label);
            });

            // Select All Logic
            allCheckbox.addEventListener('change', (e) => {
                const checked = e.target.checked;
                stationCheckboxes.forEach(cb => {
                    cb.checked = checked;
                });
                filterProperties();
            });

            function updateSelectAllState() {
                const allChecked = stationCheckboxes.every(cb => cb.checked);
                const someChecked = stationCheckboxes.some(cb => cb.checked);
                allCheckbox.checked = allChecked;
                allCheckbox.indeterminate = someChecked && !allChecked;
            }
        }

        priceSlider.addEventListener('input', () => { updateFilterLabels(); filterProperties(); });
        areaSlider.addEventListener('input', () => { updateFilterLabels(); filterProperties(); });
        walkSlider.addEventListener('input', () => { updateFilterLabels(); filterProperties(); });
        showEndedCheck.addEventListener('change', filterProperties);

        function filterProperties() {
            const maxPrice = parseFloat(priceSlider.value);
            const minArea = parseFloat(areaSlider.value);
            const maxWalk = parseFloat(walkSlider.value);

            // Get selected stations
            const checkedStations = Array.from(document.querySelectorAll('.station-checkbox:checked')).map(cb => cb.value);

            const showEnded = showEndedCheck.checked;
            const sortMode = sortSelect.value;

            let filtered = allProperties.filter(p => {
                const totalPrice = parseFloat(p.total_price) || parseFloat(p.price) || 0;
                const area = parseFloat(p.area) || 0;
                // Use actual walking distance if available, otherwise stated walk minutes
                const walk = parseFloat(p.walking_distance_actual) || parseFloat(p.walk_minutes) || 99;
                const status = p.status || 'active'; // default active

                // Status Filter
                if (!showEnded && status === 'ended') return false;

                // Range Filters
                if (totalPrice > maxPrice) return false;
                if (area < minArea) return false;
                if (walk > maxWalk) return false;

                // Station Filter (Multi-select)
                if (checkedStations.length > 0) {
                    if (!checkedStations.includes(p.nearest_station)) return false;
                } else {
                    // Default: Only show allowed stations if no specific filter is selected
                    // This ensures we hide old data that doesn't match the new criteria
                    const allowedStations = ["é–€å‰ä»²ç”ºé§…", "æœˆå³¶é§…", "è±Šæ´²é§…", "æ¸…æ¾„ç™½æ²³é§…", "æ–°å¯Œç”ºé§…"];
                    if (!allowedStations.includes(p.nearest_station)) return false;
                }

                return true;
            });

            // Grouping
            const grouped = groupProperties(filtered);

            // Sorting Groups
            grouped.sort((a, b) => {
                if (sortMode === 'newest') {
                    return (b.latestUpdate || '').localeCompare(a.latestUpdate || '');
                } else if (sortMode === 'price_asc') {
                    return a.minPrice - b.minPrice;
                } else if (sortMode === 'price_desc') {
                    return b.maxPrice - a.maxPrice;
                } else if (sortMode === 'area_desc') {
                    return b.maxArea - a.maxArea;
                } else if (sortMode === 'walk_asc') {
                    return a.minWalk - b.minWalk;
                } else if (sortMode === 'real_walk_asc') {
                    return a.minRealWalk - b.minRealWalk;
                }
                return 0;
            });

            renderGroups(grouped);
        }

        function groupProperties(properties) {
            const groups = {};
            properties.forEach(p => {
                const title = p.title || 'Unknown';
                if (!groups[title]) {
                    groups[title] = {
                        title: title,
                        items: [],
                        minPrice: Infinity,
                        maxPrice: -Infinity,
                        minArea: Infinity,
                        maxArea: -Infinity,
                        minWalk: Infinity,
                        minRealWalk: Infinity,
                        latestUpdate: '',
                        stations: new Set(),
                        address: p.address || '-',
                        source: p.source || 'Unknown'
                    };
                }
                const g = groups[title];
                g.items.push(p);

                // Aggregation
                const price = parseFloat(p.total_price) || parseFloat(p.price) || 0;
                const area = parseFloat(p.area) || 0;
                const walk = parseFloat(p.walk_minutes) || 99;
                const realWalk = parseFloat(p.walking_distance_actual) || 99;
                const updated = p.last_updated || '';

                if (price < g.minPrice) g.minPrice = price;
                if (price > g.maxPrice) g.maxPrice = price;
                if (area < g.minArea) g.minArea = area;
                if (area > g.maxArea) g.maxArea = area;
                if (walk < g.minWalk) g.minWalk = walk;
                if (realWalk < g.minRealWalk) g.minRealWalk = realWalk;
                if (updated > g.latestUpdate) g.latestUpdate = updated;
                if (p.nearest_station) g.stations.add(p.nearest_station);
            });

            return Object.values(groups);
        }

        function renderGroups(groups) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            // Count total units
            const totalUnits = groups.reduce((sum, g) => sum + g.items.length, 0);
            countSpan.textContent = totalUnits;

            if (groups.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:4rem; color:var(--text-sub); display:flex; flex-direction:column; align-items:center; gap:1rem;"><div style="font-size:3rem;">ğŸ”</div><div>æ¡ä»¶ã«åˆã†ç‰©ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>æ¡ä»¶ã‚’ç·©ã‚ã¦å†æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</div></div>';
                return;
            }

            groups.forEach(g => {
                const card = document.createElement('div');
                card.className = 'card';

                // Status check (if all ended, show ended)
                const allEnded = g.items.every(i => i.status === 'ended');
                let statusBadge = '';
                if (allEnded) {
                    statusBadge = '<span class="card-status status-ended">æ²è¼‰çµ‚äº†</span>';
                    card.style.opacity = '0.75';
                } else {
                    const activeCount = g.items.filter(i => i.status !== 'ended').length;
                    statusBadge = `<span class="card-status status-active">${activeCount}ä»¶ å‹Ÿé›†ä¸­</span>`;
                }

                // Format Ranges
                const priceDisplay = g.minPrice === g.maxPrice
                    ? `${g.minPrice.toFixed(1)}`
                    : `${g.minPrice.toFixed(1)} ~ ${g.maxPrice.toFixed(1)}`;

                const areaDisplay = g.minArea === g.maxArea
                    ? `${g.minArea}mÂ²`
                    : `${g.minArea} ~ ${g.maxArea}mÂ²`;

                const stationDisplay = Array.from(g.stations).join(', ');
                const walkDisplay = g.minWalk === 99 ? '-' : `${g.minWalk}åˆ†`;
                const realWalkDisplay = g.minRealWalk === 99 ? 'æœªè¨ˆç®—' : `${g.minRealWalk}åˆ†`;
                const lastUpdated = g.latestUpdate ? g.latestUpdate.split(' ')[0] : '-';

                // Items HTML
                const itemsHtml = g.items.map(p => {
                    const pPrice = parseFloat(p.total_price) || parseFloat(p.price);
                    const pAdmin = parseFloat(p.admin_fee);
                    const pLayout = p.layout || '-';
                    const pArea = p.area || '-';
                    const pUrl = p.url;
                    const pStatus = p.status === 'ended' ? '<span style="color:var(--danger);font-size:0.7rem;">[çµ‚äº†]</span>' : '';

                    return `
                        <a href="${pUrl}" target="_blank" style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; border-bottom:1px solid var(--border); text-decoration:none; color:inherit; transition:background 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                            <div style="display:flex; flex-direction:column; gap:2px;">
                                <div style="font-weight:700; font-size:0.95rem;">${pLayout} / ${pArea}mÂ² ${pStatus}</div>
                                <div style="font-size:0.8rem; color:var(--text-sub);">${p.floor ? p.floor + 'éš' : ''}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:700; color:var(--primary); font-family:'Outfit';">${pPrice.toFixed(1)}ä¸‡å††</div>
                                <div style="font-size:0.75rem; color:var(--text-sub);">ç®¡ç† ${pAdmin}</div>
                            </div>
                        </a>
                    `;
                }).join('');

                card.innerHTML = `
                    ${statusBadge}
                    <div class="card-body">
                        <div class="card-source">${g.source}</div>
                        <h4 class="card-title" title="${g.title}">${g.title}</h4>
                        
                        <div class="price-section">
                            <span class="total-price">${priceDisplay}<span class="price-unit">ä¸‡å††</span></span>
                        </div>

                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">é¢ç©</span>
                                <span class="info-value">${areaDisplay}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æœ€å¯„é§…</span>
                                <span class="info-value" style="font-size:0.85rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${stationDisplay}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">é§…å¾’æ­© (å…¬ç§°)</span>
                                <span class="info-value">${walkDisplay}</span>
                            </div>
                            <div class="info-item" style="background:var(--primary-light);">
                                <span class="info-label" style="color:var(--primary-dark);">Google Maps å®Ÿå¾’æ­©</span>
                                <span class="info-value" style="color:var(--primary-dark);">${realWalkDisplay}</span>
                            </div>
                        </div>

                        <div class="address">
                            ğŸ“ ${g.address}
                        </div>
                    </div>
                    
                    <!-- Expandable Section -->
                    <div style="border-top:1px solid var(--border);">
                        <button onclick="this.parentElement.querySelector('.group-items').style.display = this.parentElement.querySelector('.group-items').style.display === 'none' ? 'block' : 'none'; this.textContent = this.textContent.includes('è¡¨ç¤º') ? 'é–‰ã˜ã‚‹' : '${g.items.length}ä»¶ã‚’è¡¨ç¤º';" style="width:100%; padding:0.75rem; background:none; border:none; color:var(--primary); font-weight:700; cursor:pointer; font-size:0.9rem;">
                            ${g.items.length}ä»¶ã‚’è¡¨ç¤º
                        </button>
                        <div class="group-items" style="display:none; background:#f8fafc;">
                            ${itemsHtml}
                        </div>
                    </div>

                    <div class="card-footer">
                        <span class="last-updated">æœ€çµ‚æ›´æ–°: ${lastUpdated}</span>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
    </script>
</body>

</html>